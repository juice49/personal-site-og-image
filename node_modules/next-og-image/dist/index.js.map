{"version":3,"file":"index.js","sources":["../src/lib/get-base-url.ts","../src/lib/get-clean-path.ts","../src/lib/get-image.tsx","../src/lib/create-handler.ts"],"sourcesContent":["export default function getBaseUrl(): string | undefined {\n  if (process.env.OG_IMAGE_BASE_URL) {\n    return process.env.OG_IMAGE_BASE_URL\n  }\n\n  if (process.env.VERCEL_URL) {\n    return `https://${process.env.VERCEL_URL}`\n  }\n}\n","import { extname, basename } from 'path'\n\nexport default function getCleanPath(\n  path: string[],\n): {\n  path: string[]\n  extension: string\n} {\n  const cleanPath = [...path]\n  const finalElement = path[path.length - 1]\n  const extension = extname(finalElement)\n\n  cleanPath.splice(-1, 1, basename(finalElement, extension))\n\n  return {\n    path: cleanPath,\n    extension,\n  }\n}\n","const chromium = require('chrome-aws-lambda')\nconst playwright = require('playwright-core')\n\nexport default async function getImage(\n  baseUrl: string,\n  path: string[],\n): Promise<Buffer> {\n  const browser = await playwright.chromium.launch({\n    args: chromium.args,\n    executablePath: await chromium.executablePath,\n    headless: chromium.headless,\n  })\n\n  const context = await browser.newContext({\n    viewport: {\n      width: 2048,\n      height: 1260,\n    },\n  })\n\n  const page = await context.newPage()\n  await page.goto([baseUrl, ...path].join('/'))\n  const screenshot = await page.screenshot()\n  await browser.close()\n  return screenshot\n}\n","import { ServerResponse } from 'http'\nimport ApiRequest from '../types/api-request'\nimport getBaseUrl from './get-base-url'\nimport getCleanPath from './get-clean-path'\nimport getImage from './get-image'\n\nconst YEAR_SECONDS = 31536000\n\nexport default function createHandler(): (\n  req: ApiRequest,\n  res: ServerResponse,\n) => Promise<void> {\n  return async function handler(req, res) {\n    try {\n      const { path, extension } = getCleanPath(req.query.path)\n      const baseUrl = getBaseUrl()\n\n      if (extension !== '.png') {\n        res.statusCode = 404\n        res.setHeader('Content-Type', 'text/html')\n        res.end('<h1>Not Found</h1>')\n        return\n      }\n\n      if (!baseUrl) {\n        throw new Error(\n          'No `OG_IMAGE_BASE_URL` or `VERCEL_URL` environment variable found.',\n        )\n      }\n\n      const image = await getImage(baseUrl, path)\n      res.statusCode = 200\n      res.setHeader('Content-Type', 'image/png')\n\n      res.setHeader(\n        'Cache-Control',\n        `public, immutable, no-transform, s-maxage=${YEAR_SECONDS}, max-age=${YEAR_SECONDS}`,\n      )\n\n      res.end(image)\n    } catch (error) {\n      res.setHeader('Content-Type', 'text/html')\n      res.end('<h1>Internal Error</h1><p>Sorry, there was a problem.</p>')\n      console.error(error)\n    }\n  }\n}\n"],"names":["getBaseUrl","process","env","OG_IMAGE_BASE_URL","VERCEL_URL","getCleanPath","path","cleanPath","finalElement","length","extension","extname","splice","basename","chromium","require","playwright","getImage","baseUrl","browser","launch","args","executablePath","headless","context","newContext","viewport","width","height","page","newPage","goto","join","screenshot","close","YEAR_SECONDS","createHandler","handler","req","res","query","statusCode","setHeader","end","Error","image","error","console"],"mappings":"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"}